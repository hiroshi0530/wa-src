
## 第2章 小売店のデータでデータ加工を行う10本ノック

この記事は[「Python実践データ分析100本ノック」](https://www.amazon.co.jp/dp/B07ZSGSN9S/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1)の演習を実際にやってみたという内容になっています。今まで自己流でやってきましたが、一度他の方々がどのような考え方やコーディングをしているのか勉強してみようと思ってやってみました。本書は実際の業務に活用する上でとても参考になる内容だと思っています。データ分析に関わる仕事をしたい方にお勧めしたいです。

第２章では小売店の売り上げデータの解析、予測になります。汚いデータをいかに加工して予測のモデルを構築をして行くかという演習になっています。

こういう実務的な問題を演習として用意してくれているので、とてもありがたいです。

### github
- jupyter notebook形式のファイルは[こちら](https://github.com/hiroshi0530/wa-src/blob/master/ml/data100/02/02_nb.ipynb)

### google colaboratory
- google colaboratory で実行する場合は[こちら](https://colab.research.google.com/github/hiroshi0530/wa-src/blob/master/ml/data100/02/02_nb.ipynb)

### 筆者の環境


```python
!sw_vers
```

    ProductName:	Mac OS X
    ProductVersion:	10.14.6
    BuildVersion:	18G6020



```python
!python -V
```

    Python 3.7.3


基本的なライブラリをインポートしそのバージョンを確認しておきます。


```python
%matplotlib inline
%config InlineBackend.figure_format = 'svg'

import matplotlib
import matplotlib.pyplot as plt
import scipy
import numpy as np
import pandas as pd

print('matplotlib version :', matplotlib.__version__)
print('scipy version :', scipy.__version__)
print('numpy version :', np.__version__)
print('pandas version :', pd.__version__)
```

    matplotlib version : 3.0.3
    scipy version : 1.4.1
    numpy version : 1.16.2
    pandas version : 1.0.3


## 解答

### ノック11 : データを読み込んでみよう


```python
uriage_data = pd.read_csv('uriage.csv')
uriage_data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>purchase_date</th>
      <th>item_name</th>
      <th>item_price</th>
      <th>customer_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-06-13 18:02:34</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>深井菜々美</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-07-13 13:05:29</td>
      <td>商 品 S</td>
      <td>NaN</td>
      <td>浅田賢二</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-05-11 19:42:07</td>
      <td>商 品 a</td>
      <td>NaN</td>
      <td>南部慶二</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-02-12 23:40:45</td>
      <td>商品Z</td>
      <td>2600.0</td>
      <td>麻生莉緒</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-04-22 03:09:35</td>
      <td>商品a</td>
      <td>NaN</td>
      <td>平田鉄二</td>
    </tr>
  </tbody>
</table>
</div>



途中で半角スペースが入っていたり、大文字、小文字の差異などいい感じに表記が揺れています。一応カラム名を確認しておきます。


```python
uriage_data.columns
```




    Index(['purchase_date', 'item_name', 'item_price', 'customer_name'], dtype='object')




```python
kokyaku_data = pd.read_excel('kokyaku_daicho.xlsx')
kokyaku_data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>顧客名</th>
      <th>かな</th>
      <th>地域</th>
      <th>メールアドレス</th>
      <th>登録日</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>須賀ひとみ</td>
      <td>すが ひとみ</td>
      <td>H市</td>
      <td>suga_hitomi@example.com</td>
      <td>2018/01/04</td>
    </tr>
    <tr>
      <th>1</th>
      <td>岡田　 敏也</td>
      <td>おかだ としや</td>
      <td>E市</td>
      <td>okada_toshiya@example.com</td>
      <td>42782</td>
    </tr>
    <tr>
      <th>2</th>
      <td>芳賀 希</td>
      <td>はが のぞみ</td>
      <td>A市</td>
      <td>haga_nozomi@example.com</td>
      <td>2018/01/07</td>
    </tr>
    <tr>
      <th>3</th>
      <td>荻野  愛</td>
      <td>おぎの あい</td>
      <td>F市</td>
      <td>ogino_ai@example.com</td>
      <td>42872</td>
    </tr>
    <tr>
      <th>4</th>
      <td>栗田 憲一</td>
      <td>くりた けんいち</td>
      <td>E市</td>
      <td>kurita_kenichi@example.com</td>
      <td>43127</td>
    </tr>
  </tbody>
</table>
</div>




```python
kokyaku_data.columns
```




    Index(['顧客名', 'かな', '地域', 'メールアドレス', '登録日'], dtype='object')



### ノック12 : データの揺れを見てみよう


```python
uriage_data['item_name'].head()
```




    0      商品A
    1    商 品 S
    2    商 品 a
    3      商品Z
    4      商品a
    Name: item_name, dtype: object




```python
uriage_data['item_price'].head()
```




    0     100.0
    1       NaN
    2       NaN
    3    2600.0
    4       NaN
    Name: item_price, dtype: float64



かなりデータが揺れがあるのがわかります。

### ノック13 : データに揺れがあるまま集計してみよう 

日付がobject型なのでdatetime型に変換します。


```python
uriage_data['purchase_date'] = pd.to_datetime(uriage_data['purchase_date'])
```


```python
uriage_data[['purchase_date']].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>purchase_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-06-13 18:02:34</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-07-13 13:05:29</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-05-11 19:42:07</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-02-12 23:40:45</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-04-22 03:09:35</td>
    </tr>
  </tbody>
</table>
</div>



daetime型に変換されています。

月ごとの集計値を計算します。


```python
uriage_data['purchase_month'] = uriage_data['purchase_date'].dt.strftime('%Y%m')
res = uriage_data.pivot_table(index='purchase_month', columns='item_name', aggfunc='size', fill_value=0)
res
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>item_name</th>
      <th>商品W</th>
      <th>商 品 n</th>
      <th>商品E</th>
      <th>商品M</th>
      <th>商品P</th>
      <th>商品S</th>
      <th>商品W</th>
      <th>商品X</th>
      <th>商  品O</th>
      <th>商  品Q</th>
      <th>...</th>
      <th>商品k</th>
      <th>商品l</th>
      <th>商品o</th>
      <th>商品p</th>
      <th>商品r</th>
      <th>商品s</th>
      <th>商品t</th>
      <th>商品v</th>
      <th>商品x</th>
      <th>商品y</th>
    </tr>
    <tr>
      <th>purchase_month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>201901</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201902</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201903</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201904</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201905</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>201906</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201907</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>7 rows × 99 columns</p>
</div>




```python
res.shape
```




    (7, 99)



商品数が99個になっています。
次に価格の集計についても見てみます。


```python
res = uriage_data.pivot_table(index='purchase_month', columns='item_name', values='item_price', aggfunc='sum', fill_value=0)
res
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>item_name</th>
      <th>商品W</th>
      <th>商 品 n</th>
      <th>商品E</th>
      <th>商品M</th>
      <th>商品P</th>
      <th>商品S</th>
      <th>商品W</th>
      <th>商品X</th>
      <th>商  品O</th>
      <th>商  品Q</th>
      <th>...</th>
      <th>商品k</th>
      <th>商品l</th>
      <th>商品o</th>
      <th>商品p</th>
      <th>商品r</th>
      <th>商品s</th>
      <th>商品t</th>
      <th>商品v</th>
      <th>商品x</th>
      <th>商品y</th>
    </tr>
    <tr>
      <th>purchase_month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>201901</th>
      <td>0</td>
      <td>1400</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1100</td>
      <td>1200</td>
      <td>1500</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201902</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2400</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1900</td>
      <td>2000</td>
      <td>2200</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201903</th>
      <td>0</td>
      <td>0</td>
      <td>500</td>
      <td>1300</td>
      <td>1600</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201904</th>
      <td>2300</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1700</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1900</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201905</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1900</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>1200</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2500</td>
    </tr>
    <tr>
      <th>201906</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2300</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1600</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2400</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201907</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1500</td>
      <td>0</td>
      <td>1800</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>7 rows × 99 columns</p>
</div>



こちらも全く意味をなしてないことがわかります。

### ノック14 : 商品名の揺れを補正しよう

まずは商品名の揺れを補正していくようです。今回抽出された商品の一覧です。


```python
pd.unique(uriage_data['item_name'])
```




    array(['商品A', '商 品 S', '商 品 a', '商品Z', '商品a', '商品S', '商品 a', '商品V', '商品O',
           '商 品U', '商品L', '商  品V', '商 品O', '商品C', '商品I', '商品r', '商品X', '商品 g',
           '商品R', '商品P', '商品Q', '商品y', '商品 A', '商品N', '商品W', '商 品E', '商品K',
           '商品B', '商品F', '商 品s', '  商品W', ' 商 品 n', '商 品F', '商品D', '商品M',
           '商品Y', '商品U', '商品H', '商品T', '商品J', '商  品O', '商品E', '商  品Q', ' 商品S',
           ' 商品M', '商  品T', '商品G', '商 品G', ' 商品P', ' 商品E', '商 品N', '商 品Y',
           '商品 J', '商品 V', '商品 K', '商 品V', '商 品D', '商 品A', '商品 F', '商品 H',
           '商 品K', '商 品T', '商品 X', '商品 Q', '商 品X', '商 品H', '商 品C', '商品 B',
           '商品 O', '商品 T', '商品v', '商品p', '商品i', '商品 w', '商 品 s', '商 品 q',
           '商品s', '商品l', '商品t', '商品k', '商品g', '商品o', '商品 R', '商品 S', '商 品M',
           '商品j', '商品d', '商品 I', '商品 E', '商品 o', '商品c', '商品 v', '商品e', '商品x',
           '商 品I', ' 商品W', ' 商品X', '商品 M', '商 品P'], dtype=object)



商品数は９９個です。


```python
len(pd.unique(uriage_data['item_name']))
```




    99



スペースの有無、半角全角統一をします。文字列を扱うメソッド`str`を利用します。


```python
uriage_data['item_name'] = uriage_data['item_name'].str.upper()
uriage_data['item_name'] = uriage_data['item_name'].str.replace("　","")
uriage_data['item_name'] = uriage_data['item_name'].str.replace(" ","")
uriage_data.sort_values(by=['item_name'], ascending=True).head(3)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>purchase_date</th>
      <th>item_name</th>
      <th>item_price</th>
      <th>customer_name</th>
      <th>purchase_month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-06-13 18:02:34</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>深井菜々美</td>
      <td>201906</td>
    </tr>
    <tr>
      <th>1748</th>
      <td>2019-05-19 20:22:22</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>松川綾女</td>
      <td>201905</td>
    </tr>
    <tr>
      <th>223</th>
      <td>2019-06-25 08:13:20</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>板橋隆</td>
      <td>201906</td>
    </tr>
  </tbody>
</table>
</div>




```python
uriage_data['item_name'].unique()
```




    array(['商品A', '商品S', '商品Z', '商品V', '商品O', '商品U', '商品L', '商品C', '商品I',
           '商品R', '商品X', '商品G', '商品P', '商品Q', '商品Y', '商品N', '商品W', '商品E',
           '商品K', '商品B', '商品F', '商品D', '商品M', '商品H', '商品T', '商品J'],
          dtype=object)




```python
len(uriage_data['item_name'].unique())
```




    26



となり、商品名の揺れは解消されました。

### ノック15 :  金額欠損値の補完をしよう

金額にどれぐらいの欠損値（Null)があるか確認します。


```python
uriage_data.isnull().sum()
```




    purchase_date       0
    item_name           0
    item_price        387
    customer_name       0
    purchase_month      0
    dtype: int64




```python
uriage_data.shape
```




    (2999, 5)



行数が2999で、387行が欠損値で約１２％が欠落していることになります。

教科書では、


```python
uriage_data.isnull().any(axis=0)
```




    purchase_date     False
    item_name         False
    item_price         True
    customer_name     False
    purchase_month    False
    dtype: bool



とデータの欠損の有無を確認しています。


```python
uriage_data.isnull().head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>purchase_date</th>
      <th>item_name</th>
      <th>item_price</th>
      <th>customer_name</th>
      <th>purchase_month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>



anyメソッド、引数のオプションにaxisを指定することで、一つでもNullがあればTrueを返し、Nullの有無を確認出来ます。


```python
uriage_data.isnull().any(axis=0)
```




    purchase_date     False
    item_name         False
    item_price         True
    customer_name     False
    purchase_month    False
    dtype: bool



このNull値に対して、補完をします。少々複雑ですが、教科書では以下の通りように補完しています。それぞれのitem_nameに対して、Nullではない値の最大値を持ってきて、補完しています。


```python
flg_is_null = uriage_data['item_price'].isnull()

for trg in list(uriage_data.loc[flg_is_null, 'item_name'].unique()):
  price = uriage_data.loc[(~flg_is_null) & (uriage_data['item_name'] == trg), 'item_price'].max()
  uriage_data['item_price'].loc[(flg_is_null) & (uriage_data['item_name'] == trg)] = price
  
uriage_data.head()
```

    /Users/hiroshi/anaconda3/lib/python3.7/site-packages/pandas/core/indexing.py:671: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame
    
    See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
      self._setitem_with_indexer(indexer, value)





<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>purchase_date</th>
      <th>item_name</th>
      <th>item_price</th>
      <th>customer_name</th>
      <th>purchase_month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-06-13 18:02:34</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>深井菜々美</td>
      <td>201906</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-07-13 13:05:29</td>
      <td>商品S</td>
      <td>1900.0</td>
      <td>浅田賢二</td>
      <td>201907</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-05-11 19:42:07</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>南部慶二</td>
      <td>201905</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-02-12 23:40:45</td>
      <td>商品Z</td>
      <td>2600.0</td>
      <td>麻生莉緒</td>
      <td>201902</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-04-22 03:09:35</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>平田鉄二</td>
      <td>201904</td>
    </tr>
  </tbody>
</table>
</div>



panasのversionによって、上記の様なワーニングが出ますが、本筋ではないので無視します。興味があったら、pandasのコピーとビューについて調べてみてください。

### ノック16 : 顧客名の揺れを補正しよう

次は文字列の揺れの修正になります。


```python
kokyaku_data['顧客名'].head()
```




    0     須賀ひとみ
    1    岡田　 敏也
    2      芳賀 希
    3     荻野  愛
    4     栗田 憲一
    Name: 顧客名, dtype: object



こちらもスペースが有無に違いがある事尾がわかります。


```python
uriage_data['customer_name'].head()
```




    0    深井菜々美
    1     浅田賢二
    2     南部慶二
    3     麻生莉緒
    4     平田鉄二
    Name: customer_name, dtype: object



こちらはスペースがありません。こういった名前の表式の差異は、名前が一意キーとなっている場合ｌ、ジョインできないなどの大きいな問題になります。

こちらは、スペースを削除する方向でデータの補正を行います。


```python
kokyaku_data['顧客名'] = kokyaku_data['顧客名'].str.replace(" ","")
kokyaku_data['顧客名'] = kokyaku_data['顧客名'].str.replace("　","")
kokyaku_data['顧客名'].head()
```




    0    須賀ひとみ
    1     岡田敏也
    2      芳賀希
    3      荻野愛
    4     栗田憲一
    Name: 顧客名, dtype: object



事務レベルでは名前の補正は本当にやっかいです。このほかにも、同姓同名の処理や、漢字が同じなのに読み方が異なる場合など、大変です。

### ノック17 : 日付の揺れを補正しよう

次に日付の揺れを補正します。教科書の場合は、日付の表記が異なっていたり、エクセルの設定により日付が数字になっていたりするので、それを補正します。

まずは数値として取り込まれているデータを取得します。


```python
flg_is_series = kokyaku_data['登録日'].astype('str').str.isdigit()
flg_is_series.head()
```




    0    False
    1     True
    2    False
    3     True
    4     True
    Name: 登録日, dtype: bool




```python
flg_is_series.sum()
```




    22



isdigitがtrueである数=日付が数値として読み込まれている数が２２個である事がわかります。内容を見てみると、42xxxという数値が含まれています。


```python
kokyaku_data['登録日']
```




    0      2018/01/04
    1           42782
    2      2018/01/07
    3           42872
    4           43127
              ...    
    195    2017/06/20
    196    2018/06/20
    197    2017/04/29
    198    2019/04/19
    199    2019/04/23
    Name: 登録日, Length: 200, dtype: object



エクセルでの日付が数値になっているのは1900年1月１日からの日数ですので、to_timedeltaメソッドでその日数をdatetime型に変換し、1900年1月１日をto_datetime型に変換し、加算することで現在の日付をdatetime型で取得します。


```python
fromSerial = pd.to_timedelta(kokyaku_data.loc[flg_is_series, '登録日'].astype('float'), unit='D') + pd.to_datetime('1900/01/01')
fromSerial
```




    1     2017-02-18
    3     2017-05-19
    4     2018-01-29
    21    2017-07-06
    27    2017-06-17
    47    2017-01-08
    49    2017-07-15
    53    2017-04-10
    76    2018-03-31
    80    2018-01-12
    99    2017-06-01
    114   2018-06-05
    118   2018-01-31
    122   2018-04-18
    139   2017-05-27
    143   2017-03-26
    155   2017-01-21
    172   2018-03-24
    179   2017-01-10
    183   2017-07-26
    186   2018-07-15
    192   2018-06-10
    Name: 登録日, dtype: datetime64[ns]



次に、数値以外の日付をそのままdatetime型で取得します。


```python
fromString = pd.to_datetime(kokyaku_data.loc[~flg_is_series,'登録日'])
fromString
```




    0     2018-01-04
    2     2018-01-07
    5     2017-06-20
    6     2018-06-11
    7     2017-05-19
             ...    
    195   2017-06-20
    196   2018-06-20
    197   2017-04-29
    198   2019-04-19
    199   2019-04-23
    Name: 登録日, Length: 178, dtype: datetime64[ns]



あとはこの二つを連結すれば良いです。


```python
kokyaku_data['登録日'] = pd.concat([fromSerial, fromString])
kokyaku_data[['登録日']].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>登録日</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2018-01-04</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2017-02-18</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2018-01-07</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2017-05-19</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2018-01-29</td>
    </tr>
  </tbody>
</table>
</div>



登録年月を取得し、月ごとの登録者数を算出してみます。教科書ではgroupbyを利用してます。また、datetime型をobject型に変換するdtを利用します。


```python
kokyaku_data['登録年月'] = kokyaku_data['登録日'].dt.strftime('%Y%m')
kokyaku_data['登録年月']
```




    0      201801
    1      201702
    2      201801
    3      201705
    4      201801
            ...  
    195    201706
    196    201806
    197    201704
    198    201904
    199    201904
    Name: 登録年月, Length: 200, dtype: object




```python
res = kokyaku_data.groupby('登録年月').count()
res
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>顧客名</th>
      <th>かな</th>
      <th>地域</th>
      <th>メールアドレス</th>
      <th>登録日</th>
    </tr>
    <tr>
      <th>登録年月</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>201701</th>
      <td>15</td>
      <td>15</td>
      <td>15</td>
      <td>15</td>
      <td>15</td>
    </tr>
    <tr>
      <th>201702</th>
      <td>11</td>
      <td>11</td>
      <td>11</td>
      <td>11</td>
      <td>11</td>
    </tr>
    <tr>
      <th>201703</th>
      <td>14</td>
      <td>14</td>
      <td>14</td>
      <td>14</td>
      <td>14</td>
    </tr>
    <tr>
      <th>201704</th>
      <td>15</td>
      <td>15</td>
      <td>15</td>
      <td>15</td>
      <td>15</td>
    </tr>
    <tr>
      <th>201705</th>
      <td>13</td>
      <td>13</td>
      <td>13</td>
      <td>13</td>
      <td>13</td>
    </tr>
    <tr>
      <th>201706</th>
      <td>14</td>
      <td>14</td>
      <td>14</td>
      <td>14</td>
      <td>14</td>
    </tr>
    <tr>
      <th>201707</th>
      <td>17</td>
      <td>17</td>
      <td>17</td>
      <td>17</td>
      <td>17</td>
    </tr>
    <tr>
      <th>201801</th>
      <td>13</td>
      <td>13</td>
      <td>13</td>
      <td>13</td>
      <td>13</td>
    </tr>
    <tr>
      <th>201802</th>
      <td>15</td>
      <td>15</td>
      <td>15</td>
      <td>15</td>
      <td>15</td>
    </tr>
    <tr>
      <th>201803</th>
      <td>17</td>
      <td>17</td>
      <td>17</td>
      <td>17</td>
      <td>17</td>
    </tr>
    <tr>
      <th>201804</th>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
    </tr>
    <tr>
      <th>201805</th>
      <td>19</td>
      <td>19</td>
      <td>19</td>
      <td>19</td>
      <td>19</td>
    </tr>
    <tr>
      <th>201806</th>
      <td>13</td>
      <td>13</td>
      <td>13</td>
      <td>13</td>
      <td>13</td>
    </tr>
    <tr>
      <th>201807</th>
      <td>17</td>
      <td>17</td>
      <td>17</td>
      <td>17</td>
      <td>17</td>
    </tr>
    <tr>
      <th>201904</th>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>



教科書をコピーしているだけだとつまらないので、個人的によく利用するresampleメソッドを利用して、groupbyと同じ処理をしてみます。resampleメソッドでは2017年8月の集計がちゃんと０というように出力されます。インデックスを登録日に変更する必要があります。


```python
kokyaku_data.set_index('登録日').resample('M').count()[['顧客名']].head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>顧客名</th>
    </tr>
    <tr>
      <th>登録日</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-31</th>
      <td>15</td>
    </tr>
    <tr>
      <th>2017-02-28</th>
      <td>11</td>
    </tr>
    <tr>
      <th>2017-03-31</th>
      <td>14</td>
    </tr>
    <tr>
      <th>2017-04-30</th>
      <td>15</td>
    </tr>
    <tr>
      <th>2017-05-31</th>
      <td>13</td>
    </tr>
    <tr>
      <th>2017-06-30</th>
      <td>14</td>
    </tr>
    <tr>
      <th>2017-07-31</th>
      <td>17</td>
    </tr>
    <tr>
      <th>2017-08-31</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-09-30</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-10-31</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>



最後にエクセル由来に数値型が残っていないことを確認します。登録日のカラムはdatetime型なので一度文字列にしてから、isdigitメソッドを利用します。


```python
kokyaku_data['登録日'].astype('str').str.isdigit().sum()
```




    0



となり、ちゃんとすべての数値がdatetime型に変換されていることがわかりました。

### ノック18 : 顧客名をキーに二つのデータを結合しよう

これまでの売上履歴と顧客台帳をマージします。顧客名を一意キーとして結合します。pandasのmergeメソッドを利用します。


```python
join_data = pd.merge(uriage_data, kokyaku_data, left_on = 'customer_name', right_on = '顧客名', how='left')
join_data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>purchase_date</th>
      <th>item_name</th>
      <th>item_price</th>
      <th>customer_name</th>
      <th>purchase_month</th>
      <th>顧客名</th>
      <th>かな</th>
      <th>地域</th>
      <th>メールアドレス</th>
      <th>登録日</th>
      <th>登録年月</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-06-13 18:02:34</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>深井菜々美</td>
      <td>201906</td>
      <td>深井菜々美</td>
      <td>ふかい ななみ</td>
      <td>C市</td>
      <td>fukai_nanami@example.com</td>
      <td>2017-01-26</td>
      <td>201701</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-07-13 13:05:29</td>
      <td>商品S</td>
      <td>1900.0</td>
      <td>浅田賢二</td>
      <td>201907</td>
      <td>浅田賢二</td>
      <td>あさだ けんじ</td>
      <td>C市</td>
      <td>asada_kenji@example.com</td>
      <td>2018-04-07</td>
      <td>201804</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-05-11 19:42:07</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>南部慶二</td>
      <td>201905</td>
      <td>南部慶二</td>
      <td>なんぶ けいじ</td>
      <td>A市</td>
      <td>nannbu_keiji@example.com</td>
      <td>2018-06-19</td>
      <td>201806</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-02-12 23:40:45</td>
      <td>商品Z</td>
      <td>2600.0</td>
      <td>麻生莉緒</td>
      <td>201902</td>
      <td>麻生莉緒</td>
      <td>あそう りお</td>
      <td>D市</td>
      <td>asou_rio@example.com</td>
      <td>2018-07-22</td>
      <td>201807</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-04-22 03:09:35</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>平田鉄二</td>
      <td>201904</td>
      <td>平田鉄二</td>
      <td>ひらた てつじ</td>
      <td>D市</td>
      <td>hirata_tetsuji@example.com</td>
      <td>2017-06-07</td>
      <td>201706</td>
    </tr>
  </tbody>
</table>
</div>



当然ながら顧客名とcustomer_nameが重複するので、customer_nameを削除します。


```python
join_data = join_data.drop('customer_name', axis=1)
join_data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>purchase_date</th>
      <th>item_name</th>
      <th>item_price</th>
      <th>purchase_month</th>
      <th>顧客名</th>
      <th>かな</th>
      <th>地域</th>
      <th>メールアドレス</th>
      <th>登録日</th>
      <th>登録年月</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-06-13 18:02:34</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>201906</td>
      <td>深井菜々美</td>
      <td>ふかい ななみ</td>
      <td>C市</td>
      <td>fukai_nanami@example.com</td>
      <td>2017-01-26</td>
      <td>201701</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-07-13 13:05:29</td>
      <td>商品S</td>
      <td>1900.0</td>
      <td>201907</td>
      <td>浅田賢二</td>
      <td>あさだ けんじ</td>
      <td>C市</td>
      <td>asada_kenji@example.com</td>
      <td>2018-04-07</td>
      <td>201804</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-05-11 19:42:07</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>201905</td>
      <td>南部慶二</td>
      <td>なんぶ けいじ</td>
      <td>A市</td>
      <td>nannbu_keiji@example.com</td>
      <td>2018-06-19</td>
      <td>201806</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-02-12 23:40:45</td>
      <td>商品Z</td>
      <td>2600.0</td>
      <td>201902</td>
      <td>麻生莉緒</td>
      <td>あそう りお</td>
      <td>D市</td>
      <td>asou_rio@example.com</td>
      <td>2018-07-22</td>
      <td>201807</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-04-22 03:09:35</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>201904</td>
      <td>平田鉄二</td>
      <td>ひらた てつじ</td>
      <td>D市</td>
      <td>hirata_tetsuji@example.com</td>
      <td>2017-06-07</td>
      <td>201706</td>
    </tr>
  </tbody>
</table>
</div>



このようなデータ加工をクレンジングと言うそうです。知りませんでした。。

### ノック19 : クレンジングしたデータをダンプしよう

最後にCSVで出力するのですが、必要なカラムだけを出力します。


```python
dump_data = join_data[['purchase_date', 'purchase_month', 'item_name', 'item_price', '顧客名', 'かな', '地域', 'メールアドレス', '登録日']]
dump_data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>purchase_date</th>
      <th>purchase_month</th>
      <th>item_name</th>
      <th>item_price</th>
      <th>顧客名</th>
      <th>かな</th>
      <th>地域</th>
      <th>メールアドレス</th>
      <th>登録日</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-06-13 18:02:34</td>
      <td>201906</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>深井菜々美</td>
      <td>ふかい ななみ</td>
      <td>C市</td>
      <td>fukai_nanami@example.com</td>
      <td>2017-01-26</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-07-13 13:05:29</td>
      <td>201907</td>
      <td>商品S</td>
      <td>1900.0</td>
      <td>浅田賢二</td>
      <td>あさだ けんじ</td>
      <td>C市</td>
      <td>asada_kenji@example.com</td>
      <td>2018-04-07</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-05-11 19:42:07</td>
      <td>201905</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>南部慶二</td>
      <td>なんぶ けいじ</td>
      <td>A市</td>
      <td>nannbu_keiji@example.com</td>
      <td>2018-06-19</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-02-12 23:40:45</td>
      <td>201902</td>
      <td>商品Z</td>
      <td>2600.0</td>
      <td>麻生莉緒</td>
      <td>あそう りお</td>
      <td>D市</td>
      <td>asou_rio@example.com</td>
      <td>2018-07-22</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-04-22 03:09:35</td>
      <td>201904</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>平田鉄二</td>
      <td>ひらた てつじ</td>
      <td>D市</td>
      <td>hirata_tetsuji@example.com</td>
      <td>2017-06-07</td>
    </tr>
  </tbody>
</table>
</div>



to_csvメソッドを利用してCSVで保存します。


```python
dump_data.to_csv('dump_data.csv', index=False)
```

確認してみます。


```python
!head -n 5 dump_data.csv
```

    purchase_date,purchase_month,item_name,item_price,顧客名,かな,地域,メールアドレス,登録日
    2019-06-13 18:02:34,201906,商品A,100.0,深井菜々美,ふかい ななみ,C市,fukai_nanami@example.com,2017-01-26 00:00:00
    2019-07-13 13:05:29,201907,商品S,1900.0,浅田賢二,あさだ けんじ,C市,asada_kenji@example.com,2018-04-07 00:00:00
    2019-05-11 19:42:07,201905,商品A,100.0,南部慶二,なんぶ けいじ,A市,nannbu_keiji@example.com,2018-06-19 00:00:00
    2019-02-12 23:40:45,201902,商品Z,2600.0,麻生莉緒,あそう りお,D市,asou_rio@example.com,2018-07-22 00:00:00


### ノック20 : データを集計しよう

ノック１９で加工したデータを利用して、再度集計処理をしてみます。


```python
import_data = pd.read_csv('dump_data.csv')
import_data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>purchase_date</th>
      <th>purchase_month</th>
      <th>item_name</th>
      <th>item_price</th>
      <th>顧客名</th>
      <th>かな</th>
      <th>地域</th>
      <th>メールアドレス</th>
      <th>登録日</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-06-13 18:02:34</td>
      <td>201906</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>深井菜々美</td>
      <td>ふかい ななみ</td>
      <td>C市</td>
      <td>fukai_nanami@example.com</td>
      <td>2017-01-26 00:00:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-07-13 13:05:29</td>
      <td>201907</td>
      <td>商品S</td>
      <td>1900.0</td>
      <td>浅田賢二</td>
      <td>あさだ けんじ</td>
      <td>C市</td>
      <td>asada_kenji@example.com</td>
      <td>2018-04-07 00:00:00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-05-11 19:42:07</td>
      <td>201905</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>南部慶二</td>
      <td>なんぶ けいじ</td>
      <td>A市</td>
      <td>nannbu_keiji@example.com</td>
      <td>2018-06-19 00:00:00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-02-12 23:40:45</td>
      <td>201902</td>
      <td>商品Z</td>
      <td>2600.0</td>
      <td>麻生莉緒</td>
      <td>あそう りお</td>
      <td>D市</td>
      <td>asou_rio@example.com</td>
      <td>2018-07-22 00:00:00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-04-22 03:09:35</td>
      <td>201904</td>
      <td>商品A</td>
      <td>100.0</td>
      <td>平田鉄二</td>
      <td>ひらた てつじ</td>
      <td>D市</td>
      <td>hirata_tetsuji@example.com</td>
      <td>2017-06-07 00:00:00</td>
    </tr>
  </tbody>
</table>
</div>



purchase_monthに対して商品ごとの集計をします。


```python
byItem = import_data.pivot_table(index='purchase_month', columns='item_name', aggfunc='size', fill_value=0)
byItem.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>item_name</th>
      <th>商品A</th>
      <th>商品B</th>
      <th>商品C</th>
      <th>商品D</th>
      <th>商品E</th>
      <th>商品F</th>
      <th>商品G</th>
      <th>商品H</th>
      <th>商品I</th>
      <th>商品J</th>
      <th>...</th>
      <th>商品Q</th>
      <th>商品R</th>
      <th>商品S</th>
      <th>商品T</th>
      <th>商品U</th>
      <th>商品V</th>
      <th>商品W</th>
      <th>商品X</th>
      <th>商品Y</th>
      <th>商品Z</th>
    </tr>
    <tr>
      <th>purchase_month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>201901</th>
      <td>18</td>
      <td>13</td>
      <td>19</td>
      <td>17</td>
      <td>18</td>
      <td>15</td>
      <td>11</td>
      <td>16</td>
      <td>18</td>
      <td>17</td>
      <td>...</td>
      <td>17</td>
      <td>21</td>
      <td>20</td>
      <td>17</td>
      <td>7</td>
      <td>22</td>
      <td>13</td>
      <td>14</td>
      <td>10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201902</th>
      <td>19</td>
      <td>14</td>
      <td>26</td>
      <td>21</td>
      <td>16</td>
      <td>14</td>
      <td>14</td>
      <td>17</td>
      <td>12</td>
      <td>14</td>
      <td>...</td>
      <td>22</td>
      <td>22</td>
      <td>22</td>
      <td>23</td>
      <td>19</td>
      <td>22</td>
      <td>24</td>
      <td>16</td>
      <td>11</td>
      <td>1</td>
    </tr>
    <tr>
      <th>201903</th>
      <td>17</td>
      <td>21</td>
      <td>20</td>
      <td>17</td>
      <td>9</td>
      <td>27</td>
      <td>14</td>
      <td>18</td>
      <td>12</td>
      <td>16</td>
      <td>...</td>
      <td>23</td>
      <td>16</td>
      <td>20</td>
      <td>12</td>
      <td>23</td>
      <td>18</td>
      <td>16</td>
      <td>21</td>
      <td>16</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201904</th>
      <td>17</td>
      <td>19</td>
      <td>24</td>
      <td>20</td>
      <td>18</td>
      <td>17</td>
      <td>14</td>
      <td>11</td>
      <td>18</td>
      <td>13</td>
      <td>...</td>
      <td>20</td>
      <td>20</td>
      <td>16</td>
      <td>16</td>
      <td>11</td>
      <td>15</td>
      <td>14</td>
      <td>16</td>
      <td>20</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201905</th>
      <td>24</td>
      <td>14</td>
      <td>16</td>
      <td>14</td>
      <td>19</td>
      <td>18</td>
      <td>23</td>
      <td>15</td>
      <td>16</td>
      <td>11</td>
      <td>...</td>
      <td>13</td>
      <td>22</td>
      <td>18</td>
      <td>16</td>
      <td>16</td>
      <td>9</td>
      <td>21</td>
      <td>16</td>
      <td>20</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26 columns</p>
</div>



とても綺麗なテーブルになっていると思います。次に、売上金額です。


```python
byPrice = import_data.pivot_table(index='purchase_month', columns='item_name',values='item_price', aggfunc='sum', fill_value=0)
byPrice.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>item_name</th>
      <th>商品A</th>
      <th>商品B</th>
      <th>商品C</th>
      <th>商品D</th>
      <th>商品E</th>
      <th>商品F</th>
      <th>商品G</th>
      <th>商品H</th>
      <th>商品I</th>
      <th>商品J</th>
      <th>...</th>
      <th>商品Q</th>
      <th>商品R</th>
      <th>商品S</th>
      <th>商品T</th>
      <th>商品U</th>
      <th>商品V</th>
      <th>商品W</th>
      <th>商品X</th>
      <th>商品Y</th>
      <th>商品Z</th>
    </tr>
    <tr>
      <th>purchase_month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>201901</th>
      <td>1800</td>
      <td>2600</td>
      <td>5700</td>
      <td>6800</td>
      <td>9000</td>
      <td>9000</td>
      <td>7700</td>
      <td>12800</td>
      <td>16200</td>
      <td>17000</td>
      <td>...</td>
      <td>28900</td>
      <td>37800</td>
      <td>38000</td>
      <td>34000</td>
      <td>14700</td>
      <td>48400</td>
      <td>29900</td>
      <td>33600</td>
      <td>25000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201902</th>
      <td>1900</td>
      <td>2800</td>
      <td>7800</td>
      <td>8400</td>
      <td>8000</td>
      <td>8400</td>
      <td>9800</td>
      <td>13600</td>
      <td>10800</td>
      <td>14000</td>
      <td>...</td>
      <td>37400</td>
      <td>39600</td>
      <td>41800</td>
      <td>46000</td>
      <td>39900</td>
      <td>48400</td>
      <td>55200</td>
      <td>38400</td>
      <td>27500</td>
      <td>2600</td>
    </tr>
    <tr>
      <th>201903</th>
      <td>1700</td>
      <td>4200</td>
      <td>6000</td>
      <td>6800</td>
      <td>4500</td>
      <td>16200</td>
      <td>9800</td>
      <td>14400</td>
      <td>10800</td>
      <td>16000</td>
      <td>...</td>
      <td>39100</td>
      <td>28800</td>
      <td>38000</td>
      <td>24000</td>
      <td>48300</td>
      <td>39600</td>
      <td>36800</td>
      <td>50400</td>
      <td>40000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201904</th>
      <td>1700</td>
      <td>3800</td>
      <td>7200</td>
      <td>8000</td>
      <td>9000</td>
      <td>10200</td>
      <td>9800</td>
      <td>8800</td>
      <td>16200</td>
      <td>13000</td>
      <td>...</td>
      <td>34000</td>
      <td>36000</td>
      <td>30400</td>
      <td>32000</td>
      <td>23100</td>
      <td>33000</td>
      <td>32200</td>
      <td>38400</td>
      <td>50000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201905</th>
      <td>2400</td>
      <td>2800</td>
      <td>4800</td>
      <td>5600</td>
      <td>9500</td>
      <td>10800</td>
      <td>16100</td>
      <td>12000</td>
      <td>14400</td>
      <td>11000</td>
      <td>...</td>
      <td>22100</td>
      <td>39600</td>
      <td>34200</td>
      <td>32000</td>
      <td>33600</td>
      <td>19800</td>
      <td>48300</td>
      <td>38400</td>
      <td>50000</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26 columns</p>
</div>



次に顧客ごとの販売数です。


```python
Customer = import_data.pivot_table(index='purchase_month', columns='顧客名', aggfunc='size', fill_value=0)
Customer.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>顧客名</th>
      <th>さだ千佳子</th>
      <th>中仁晶</th>
      <th>中田美智子</th>
      <th>丸山光臣</th>
      <th>久保田倫子</th>
      <th>亀井一徳</th>
      <th>五十嵐春樹</th>
      <th>井上桃子</th>
      <th>井口寛治</th>
      <th>井川真悠子</th>
      <th>...</th>
      <th>香椎優一</th>
      <th>高原充則</th>
      <th>高梨結衣</th>
      <th>高沢美咲</th>
      <th>高田さんま</th>
      <th>鳥居広司</th>
      <th>鶴岡薫</th>
      <th>麻生莉緒</th>
      <th>黄川田博之</th>
      <th>黒谷長利</th>
    </tr>
    <tr>
      <th>purchase_month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>201901</th>
      <td>3</td>
      <td>1</td>
      <td>4</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>5</td>
      <td>3</td>
      <td>3</td>
      <td>1</td>
      <td>...</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>5</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>201902</th>
      <td>9</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>...</td>
      <td>4</td>
      <td>0</td>
      <td>3</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>4</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>201903</th>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>4</td>
      <td>3</td>
      <td>3</td>
      <td>2</td>
      <td>2</td>
      <td>...</td>
      <td>3</td>
      <td>1</td>
      <td>6</td>
      <td>2</td>
      <td>4</td>
      <td>2</td>
      <td>4</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>201904</th>
      <td>0</td>
      <td>3</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>3</td>
      <td>2</td>
      <td>...</td>
      <td>2</td>
      <td>4</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
      <td>3</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>201905</th>
      <td>3</td>
      <td>2</td>
      <td>5</td>
      <td>2</td>
      <td>4</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>3</td>
      <td>3</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
      <td>4</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 199 columns</p>
</div>



次に地域ごとにおける販売数です。


```python
Region = import_data.pivot_table(index='purchase_month', columns='地域', aggfunc='size', fill_value=0)
Region.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>地域</th>
      <th>A市</th>
      <th>B市</th>
      <th>C市</th>
      <th>D市</th>
      <th>E市</th>
      <th>F市</th>
      <th>G市</th>
      <th>H市</th>
    </tr>
    <tr>
      <th>purchase_month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>201901</th>
      <td>59</td>
      <td>55</td>
      <td>72</td>
      <td>34</td>
      <td>49</td>
      <td>57</td>
      <td>49</td>
      <td>42</td>
    </tr>
    <tr>
      <th>201902</th>
      <td>71</td>
      <td>46</td>
      <td>65</td>
      <td>48</td>
      <td>61</td>
      <td>52</td>
      <td>43</td>
      <td>63</td>
    </tr>
    <tr>
      <th>201903</th>
      <td>64</td>
      <td>52</td>
      <td>57</td>
      <td>43</td>
      <td>52</td>
      <td>59</td>
      <td>51</td>
      <td>59</td>
    </tr>
    <tr>
      <th>201904</th>
      <td>64</td>
      <td>48</td>
      <td>54</td>
      <td>45</td>
      <td>48</td>
      <td>58</td>
      <td>40</td>
      <td>52</td>
    </tr>
    <tr>
      <th>201905</th>
      <td>57</td>
      <td>52</td>
      <td>68</td>
      <td>48</td>
      <td>59</td>
      <td>65</td>
      <td>35</td>
      <td>43</td>
    </tr>
  </tbody>
</table>
</div>



とても便利で、実用的です。最後に集計期間で購入していない顧客の洗い出しをしています。purchase_dataがNullのユーザーを抽出しています。


```python
away_data = pd.merge(uriage_data, kokyaku_data, left_on='customer_name', right_on='顧客名', how='right')
away_data[away_data['purchase_date'].isnull()][['顧客名', '登録日']]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>顧客名</th>
      <th>登録日</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2999</th>
      <td>福井美希</td>
      <td>2019-04-23</td>
    </tr>
  </tbody>
</table>
</div>



とても有意義な演習でした。実際の現場はもっとデータが汚いかと思いますが、演習の題材としては非常に勉強になるものでした。教科書の著者に感謝申し上げます。

## 関連記事
- [第1章 ウェブからの注文数を分析する10本ノック](/ml/data100/01/)
- [第2章 小売店のデータでデータ加工を行う10本ノック](/ml/data100/02/)
- [第3章 顧客の全体像を把握する10本ノック](/ml/data100/03/)
- [第4章 顧客の行動を予測する10本ノック](/ml/data100/04/)
- [第5章 顧客の退会を予測する10本ノック](/ml/data100/05/)
- [第6章 物流の最適ルートをコンサルティングする10本ノック](/ml/data100/06/)
- [第7章 ロジスティクスネットワークの最適設計を行う10本ノック](/ml/data100/07/)
- [第8章 数値シミュレーションで消費者行動を予測する10本ノック](/ml/data100/08/)
- [第9章 潜在顧客を把握するための画像認識10本ノック](/ml/data100/09/)
- [第10章 アンケート分析を行うための自然言語処理10本ノック](/ml/data100/10/)
